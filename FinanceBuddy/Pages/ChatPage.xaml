<?xml version="1.0" encoding="utf-8" ?>
<ContentPage xmlns="http://schemas.microsoft.com/dotnet/2021/maui"
             xmlns:x="http://schemas.microsoft.com/winfx/2009/xaml"
             xmlns:components="clr-namespace:FinanceBuddy.Components"
             x:Class="FinanceBuddy.Pages.ChatPage"
             Title="Chat">
    <Grid RowDefinitions="Auto,Auto,Auto,Auto,*,Auto" BackgroundColor="{StaticResource Background}">
        
        <!-- Plant Status -->
        <components:PlantStatusView x:Name="PlantStatus" Grid.Row="0" Margin="12,8" />
        
        <!-- Header -->
        <Grid Grid.Row="1" ColumnDefinitions="*,Auto" Padding="12" BackgroundColor="{StaticResource Background}">
            <Label Text="Money Mentor" FontAttributes="Bold" TextColor="{StaticResource TextPrimary}" />
            <Label Grid.Column="1" Text="Connected" FontSize="10" TextColor="{StaticResource TextSecondary}" HorizontalTextAlignment="End" VerticalTextAlignment="Center" />
        </Grid>

        <!-- Language Selection & Auto Detect Toggle -->
        <Grid Grid.Row="2" ColumnDefinitions="Auto,*,Auto" Padding="12,0,12,4" BackgroundColor="{StaticResource Background}" ColumnSpacing="8">
            <Label Text="Language:" VerticalOptions="Center" TextColor="{StaticResource TextPrimary}" FontSize="14" />
            <Picker x:Name="LanguagePicker" 
                    Grid.Column="1" 
                    Title="Select Language"
                    TextColor="{StaticResource TextPrimary}"
                    BackgroundColor="{StaticResource Surface}"
                    SelectedIndexChanged="OnLanguageChanged" />
            <VerticalStackLayout Grid.Column="2" Spacing="0" HorizontalOptions="End" VerticalOptions="Center">
                <HorizontalStackLayout Spacing="4" VerticalOptions="Center">
                    <Label Text="Auto" FontSize="11" TextColor="{StaticResource TextSecondary}" VerticalOptions="Center"/>
                    <Switch x:Name="AutoDetectSwitch" Toggled="OnAutoDetectToggled" VerticalOptions="Center" />
                </HorizontalStackLayout>
                <Label x:Name="AutoDetectInfoLabel" Text="" FontSize="10" TextColor="{StaticResource TextSecondary}" />
            </VerticalStackLayout>
        </Grid>

        <!-- Current Detected Language Display -->
        <Label Grid.Row="3" x:Name="DetectedLanguageLabel" Text="" FontSize="12" TextColor="{StaticResource TextSecondary}" Padding="12,0,12,4"/>

        <!-- Messages -->
        <CollectionView x:Name="MessagesView" Grid.Row="4" Margin="8" BackgroundColor="{StaticResource Background}">
            <CollectionView.ItemTemplate>
                <DataTemplate>
                    <Grid Padding="4">
                        <Grid MaximumWidthRequest="320">
                            <Grid.Style>
                                <Style TargetType="Grid">
                                    <Style.Triggers>
                                        <DataTrigger TargetType="Grid" Binding="{Binding IsUser}" Value="True">
                                            <Setter Property="HorizontalOptions" Value="End" />
                                        </DataTrigger>
                                        <DataTrigger TargetType="Grid" Binding="{Binding IsUser}" Value="False">
                                            <Setter Property="HorizontalOptions" Value="Start" />
                                        </DataTrigger>
                                    </Style.Triggers>
                                </Style>
                            </Grid.Style>
                            <Border StrokeThickness="0" Padding="12" StrokeShape="RoundRectangle 18">
                                <Border.Style>
                                    <Style TargetType="Border">
                                        <Style.Triggers>
                                            <DataTrigger TargetType="Border" Binding="{Binding IsUser}" Value="True">
                                                <Setter Property="BackgroundColor" Value="{StaticResource BubbleUser}" />
                                            </DataTrigger>
                                            <DataTrigger TargetType="Border" Binding="{Binding IsUser}" Value="False">
                                                <Setter Property="BackgroundColor" Value="{StaticResource BubbleAgent}" />
                                            </DataTrigger>
                                        </Style.Triggers>
                                    </Style>
                                </Border.Style>
                                <VerticalStackLayout Spacing="4">
                                    <Label Text="{Binding Text}" TextColor="{StaticResource White}" />
                                    <Label Text="{Binding Timestamp, StringFormat='{}{0:HH:mm}'}" FontSize="11" TextColor="#E0E0E0" HorizontalOptions="End" />
                                </VerticalStackLayout>
                            </Border>
                        </Grid>
                    </Grid>
                </DataTemplate>
            </CollectionView.ItemTemplate>
        </CollectionView>

        <!-- Input Area -->
        <Grid Grid.Row="5" ColumnDefinitions="*,Auto" Padding="8" BackgroundColor="{StaticResource Surface}" Margin="8">
            <Entry x:Name="InputEntry" Grid.Column="0" Placeholder="Type your message" TextColor="{StaticResource TextPrimary}" PlaceholderColor="{StaticResource TextSecondary}" BackgroundColor="Transparent" HeightRequest="44" VerticalOptions="Center" />
            <Button Grid.Column="1" Text="Send" Clicked="OnSend" BackgroundColor="{StaticResource Primary}" TextColor="{StaticResource White}" Margin="8,0,0,0" />
        </Grid>
    </Grid>
</ContentPage>